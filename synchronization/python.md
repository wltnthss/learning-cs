## 동기화

공유하는 프로세스들은 실행 순서와 일관성이 보장해야 하기에 동기화(synchronization) 해야함.

동기화 : 특정 자원에 접근할 때 한 개의 프로세스만 접근하거나 프로세스를 올바른 순서대로 실행하게 하는 것

프로세스 동기화란 크게 두 가지를 말함.

- 실행 순서 제어 : 프로세스를 올바른 순서대로 실행.

ex) 파일에 값을 저장하는 Writer 프로세스, 파일에 저장된 값을 읽어 들이는 Reader 프로세스 

Reader 프로세스는 Writer 프로세스가 파일에 저장을 한 후에 실행되어야 하는 특정 조건이 만족되어야함.

- 상호 배제 : 동시에 접근해서는 안 되는 자원에 하나의 프로세스만 접근.

ex) 프로세스 A 계좌에 10만원 잔액을 읽어들임 -> 잔액 + 2만원 -> 더한 값 저장

프로세스 B 계좌에 10만원 잔액을 읽어들임 -> 잔액 + 5만원 -> 더한 값 저장

동기화가 이루어지지 않은 경우 A가 끝나기 전에 B가 잔액을 읽으면 15만원이 되어버릴 수 있는 문제점 발생.

동기화가 이루어진 경우 A의 계좌에 2만원 더한 값을 저장 후 B프로세스가 실행되므로 최종잔액 17만원 저장.

### 공유 자원과 임계 구역

위의 계좌 잔액 문제와 같이 동시에 실행되는 프로세스들은 전역 변수 '잔액' 공동의 자원을 두고 사용했는데

이를 ```공유 자원```이라고 함. (공유 자원은 전역 변수가 될 수도, 파일이 될 수도, 입출력장치가 될 수도 있음)

또한 동시에 실행하면 문제가 발생하는 자원에 접근하는 코드 영역을 ```임계 구역```이라고 함.

![image](https://github.com/wltnthss/learning-cs/assets/60785586/c9a736d0-a11c-4ab9-a2d7-767f62bfee6f)

또한 임계 구역은 두 개 이상의 프로세스가 실행되면 안 되는 영역이지만, 

잘못된 실행으로 인해 여러 프로세스가 임계 구역의 코드를 실행하는 경우 이를 ```레이스 컨디션``` 이라고 함.

이 때 상호 배제를 위한 동기화는 이와 같은 일이 발생하지 않도록 두 개 이상의 프로세스가 동시에 접근하지 못하도록 관리함.

상호 배제를 위한 동기화를 위해서는 세 가지 원칙이 반드시 지켜져야함.

- 상호 배제 : 한 프로세스가 임계 구역에 진입했다면 다른 프로세스는 임계 구역에 들어올 수 없음.

- 진행 : 임계 구역에 어떤 프로세스도 진입하지 않았다면, 임계 구역에 진입하고자 하는 프로세스는 들어갈 수 있어야함.

- 유한 대기 : 한 프로세스가 임계 구역에 진입하고 싶다면, 그 프로세스는 언젠가는 임계 구역에 들어올 수 있어야함.

### 동기화 기법

#### 뮤텐스 락

EX) 손님이 탈의실에 들어가는 경우 , 탈의실에는 한 명의 인원만 사용 가능함.

손님은 '프로세스', 탈의실은 '임계 구역' 탈의실을 사용할 때 자물쇠를 거는데 이 기능을 코드로 구현 한 것이 ```뮤텐스 락``` 임.

뮤텐스 락의 단순한 형태는 하나의 전역 변수, 두 개의 함수로 구현 가능함.

- 자물쇠 역할 : 프로세스들이 공유하는 전역 변수 lock

- 임계 구역을 잠그는 역할 : acquire 함수

- 임계 구역의 잠금을 해제하는 역할 : release 함수

acquire 함수는 임계 구역에 진입하기 전에 호출하는 함수.

임계 구역이 잠겨 있다면 열릴 때 까지 임계 구역을 반복적으로 확인, 열려 있다면 임계 구역을 잠그는 함수.

release 함수는 임계 구역세어 작업이 끝나고 호출하는 함수. 잠김 임계 구역을 열어주는 함수.

```
acquire() {
  while (lock == true)  // 임계 구역이 잠겨 있을 경우
    ;                   // 임계 구역이 잠겨 있는지 반복 확인
  lock = true;          // 임계 구역이 잠겨 있지 않다면 임계 구역 잠금
}

release() {
  lock = false;         // 임계 구역 작업이 끝났으니 잠금 해제
}
```

#### 세마포

뮤텐스 락은 하나의 탈의실의 경우라면 세마포는 다수의 탈의실의 경우에 해당함.

뮤텐스 락을 사용할 떄 임계 구역 진입 전후로 acquire() 과 relase() 를 호출했듯이

세마포에서도 임계 구역 진입 전후로 wait() 과 signal()을 호출함. (함수의 경우는 다를 수 있음)

```
wait() {
  while( S <= 0 )    // 임계 구역에 진입할 수 있는 프로세스 개수가 0이하라면
    ;                // 사용할 수 있는 자원이 있는지 반복확인
  S--;               // 임계 구역에 진입할 수 있는 프로세스 개수가 하나 이상이면 S를 1감소시키고 임계 구역 진입
}

signal() {
  S++                // 임계 구역에서의 작업을 마친 뒤 S를 1증가.
}
```

#### 모니터 

뮤텍스, 세마포와 달리 하나의 프로세스내에서 다른 스레드 간의 동기화에 사용되며

일련의 동기화 작업들이 캡슐화되어 있어서 synchronized, wait(), notify()등을 사용하여 보다 편리한 동기화 가능.

즉, 세마포, 뮤텍스와 달리 wait, signal 설정 없이 함수 앞에 synchronized만 붙이면 상호배제하여 함수 작업을 수행함.

